<!DOCTYPE html>
<html>
<head>
    <title>CRUD Tables</title>
    <style>
        /* Your existing CSS */
    </style>
</head>
<body>
    <h1>Publishers</h1>
    <table>
        <thead>
            <tr>
                <th>Publisher ID</th>
                <th>Publisher Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="publisherTableBody"></tbody>
    </table>

    <h2>Subjects</h2>
    <table>
        <thead>
            <tr>
                <th>Subject ID</th>
                <th>Subject Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="subjectTableBody"></tbody>
    </table>

    <script>
        function createEditableCell(endpoint, ID, field, value) {
            return `
                <td>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span class="display-text">${value}</span>
                        <input class="edit-input" type="text" value="${value}" style="display: none;"
                            data-endpoint="${endpoint}" data-id="${ID}" data-field="${field}"
                            onblur="finishEdit(this)" onkeydown="handleKey(event, this)">
                        <button class="edit-btn" onclick="startEdit(this)" 
                            style="background: none; border: none; cursor: pointer;">✏️</button>
                    </div>
                </td>
            `;
        }

        function startEdit(button) {
            const td = button.closest('td');
            td.querySelector('.display-text').style.display = 'none';
            const input = td.querySelector('.edit-input');
            input.style.display = 'inline';
            input.focus();
        }

        function finishEdit(input) {
            const td = input.closest('td');
            const newValue = input.value.trim();
            td.querySelector('.display-text').textContent = newValue;
            td.querySelector('.display-text').style.display = 'inline';
            input.style.display = 'none';
            updateCell(input.dataset.endpoint, input.dataset.id, input.dataset.field, newValue);
        }

        function handleKey(event, input) {
            if (event.key === 'Enter') {
                input.blur();
            } else if (event.key === 'Escape') {
                const td = input.closest('td');
                input.value = td.querySelector('.display-text').textContent;
                input.style.display = 'none';
                td.querySelector('.display-text').style.display = 'inline';
            }
        }

        async function updateCell(endpoint, ID, field, value) {
            const res = await fetch(`${endpoint}/${ID}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ field, value })
            });
            if (!res.ok) alert('Failed to update.');
        }

        async function fetchPublishers() {
            const res = await fetch('/publishers');
            const data = await res.json();
            const tbody = document.getElementById('publisherTableBody');
            tbody.innerHTML = '';

            data.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    ${createEditableCell('/publishers', p.pubID, 'pubID', p.pubID)}
                    ${createEditableCell('/publishers', p.pubID, 'pname', p.pname)}
                    ${createEditableCell('/publishers', p.pubID, 'email', p.email)}
                    ${createEditableCell('/publishers', p.pubID, 'phone', p.phone || '')}
                    <td><button onclick="deleteItem('/publishers', ${p.pubID}, fetchPublishers)">Delete</button></td>
                `;
                tbody.appendChild(row);
            });

            const inputRow = document.createElement('tr');
            inputRow.innerHTML = `
                <td><input type="text" id="pubID" placeholder="ID"></td>
                <td><input type="text" id="name" placeholder="Name"></td>
                <td><input type="email" id="email" placeholder="Email"></td>
                <td><input type="text" id="phone" placeholder="Phone"></td>
                <td><button onclick="addPublisher()">Add</button></td>
            `;
            tbody.appendChild(inputRow);
        }

        async function fetchSubjects() {
            const res = await fetch('/subjects');
            const data = await res.json();
            const tbody = document.getElementById('subjectTableBody');
            tbody.innerHTML = '';

            data.forEach(s => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    ${createEditableCell('/subjects', s.subID, 'subID', s.subID)}
                    ${createEditableCell('/subjects', s.subID, 'sName', s.sName)}
                    <td><button onclick="deleteItem('/subjects', '${s.subID}', fetchSubjects)">Delete</button></td>
                `;
                tbody.appendChild(row);
            });

            const inputRow = document.createElement('tr');
            inputRow.innerHTML = `
                <td><input type="text" id="subID" placeholder="ID"></td>
                <td><input type="text" id="sName" placeholder="Name"></td>
                <td><button onclick="addSubject()">Add</button></td>
            `;
            tbody.appendChild(inputRow);
        }

        async function deleteItem(endpoint, id, refreshFn) {
            if (!confirm(`Delete item ${id}?`)) return;
            const res = await fetch(`${endpoint}/${id}`, { method: 'DELETE' });
            if (res.ok) refreshFn();
            else alert('Failed to delete item.');
        }

        async function addPublisher() {
            const pubID = document.getElementById('pubID').value.trim();
            const pname = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!pname || !email) {
                alert('Name and Email are required.');
                return;
            }

            const res = await fetch('/publishers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pubID, pname, email, phone })
            });

            if (res.ok) fetchPublishers();
            else alert('Failed to add publisher.');
        }

        async function addSubject() {
            const subID = document.getElementById('subID').value.trim();
            const sName = document.getElementById('sName').value.trim();

            if (!sName) {
                alert('Subject Name is required.');
                return;
            }

            const res = await fetch('/subjects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subID, sName })
            });

            if (res.ok) fetchSubjects();
            else alert('Failed to add subject.');
        }

        window.onload = () => {
            fetchPublishers();
            fetchSubjects();
        };
    </script>
</body>
</html>
